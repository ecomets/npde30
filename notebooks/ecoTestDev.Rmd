---
title: "Testing package with devtools"
author: "Emmanuelle Comets"
date: "02/02/2021"
output:
  pdf_document: default
  html_document: default
---


## Notes before release

- package
  -  **TODO** automatically load libraries when loading *npde* ()
    - ggplot2 not loaded, gridExtra, mclust not loaded
    - check: mclust
  - compilation: compiled package as npde 3.0
    - version number 3.0 because reference profiles included
    - lots of error messages for "no visible binding for global variable" in variables related to ggplot2 (Undefined global functions or variables) => hope this does not block us for CRAN
- TODO *npde website* (bookdown, Eco)
- code **TODO** for 3.1
  - add an option to remove all output when required and remove warnings if requested
- **TODO** simplify output for *show()* function (v3.0 or v3.1 ?)

## Setup, loading libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
library(ggplot2)
library(gridExtra)
library(mclust)
library(testthat)
# library(grid)
workDir<-"/home/eco/work/npde/npde30"
#setwd(workDir)
knitr::opts_chunk$set(root.dir = workDir)

docFigs<-"/home/eco/work/npde/doclib/figs"
saveDocPlots<-FALSE
savePaperPlots<-FALSE
```

### Install package in development mode
  
```{r devModeInstall}
dev_mode() # development mode
install.packages(pkgs=file.path(workDir,"npde_3.0.tar.gz"),repos=NULL)
library(npde)
```


## Running examples from documentation

### Checking help files work

OK

```{r helpFiles, echo=FALSE}
?theopp
?autonpde
```
###  Computing npde for theophylline data

Checking that the results are the same when we use data frames versus files on disk: OK

Missing data (lines with MDV=1) removed from the data for plots (also removed from simulated data for approx.pi=TRUE, as per documentation the simulated and observed data must have compatible dimensions).

```{r theoRun, echo=FALSE}
data(theopp)
data(simtheopp)

# Calling autonpde with dataframes
theofit1<-autonpde(theopp,simtheopp,1,3,4,boolsave=FALSE, units=list(x="hr",y="mg/L"))
theofit1

# Calling autonpde with names of files to be read from disk
write.table(theopp,"theopp.tab",quote=FALSE,row.names=FALSE)
write.table(simtheopp,"simtheopp.tab",quote=FALSE,row.names=FALSE)
theofit<-autonpde(namobs="theopp.tab", namsim="simtheopp.tab", iid = 1,
            ix = 3, iy = 4, imdv=0, boolsave = FALSE, units=list(x="hr",y="mg/L"))
head(theofit["results"]["res"])
cat("Same results with data frame and with data on disk:",identical(theofit,theofit1),"\n")

# Debug
if(FALSE) {
  npdeObject<-theofit1
  npde.plot.scatterplot(theofit1)
  distrib<-"norm"
  which<-"npde"
  plot.opt<-theofit1@prefs
  npde.plot.dist(theofit1)
}

```

Show and print function :

- modified so that print(theofit) shows the results of gof.test applied to the object
- show displays the first 10 lines of the results dataframe
- **TODO** simplify output for *show()* function (v3.0 or v3.1 ?)

```{r theShow, echo=FALSE}
show(theofit)

print(theofit)
```

###  Computing npde for viral load data

- For censored viral load data (20 or 50 cp/mL), we compute the npde using the different methods implemented in the package. We expect:
  - NS for yvir1, yvir20, yvir50 (complete datasets, and censored datasets with imputed BQL)
  - significant for ppred method
  - NS for omit method because we also omit BQL data in the simulations (so OK)
  - NS for ipred method

```{r virloadRun, echo=FALSE}
#Viral load data
data(virload)
data(virload20)
data(virload50)
data(simvirload)

#Plotting the data
par(mfrow=c(1,2))
plot(Log_VL~Time,data=virload,xlab="Time (d)",ylab="Viral loads, base 10 log-scale (cp/mL)")
plot(Log_VL~Time,data=virload50,xlab="Time (d)",ylab="Viral loads, base 10 log-scale (cp/mL)")

# Calling autonpde with dataframes
yvir1<-autonpde(virload,simvirload,iid=1,ix=2,iy=3,boolsave=FALSE, units=list(x="hr", y="cp/mL, log 10 base"))

yvir20<-autonpde(virload20,simvirload,iid=1,ix=2,iy=3, icens=4, boolsave=FALSE)

yvir2<-autonpde(virload50,simvirload,iid=1,ix=2,iy=3,boolsave=FALSE)

yvir50<-autonpde(virload50,simvirload,iid=1,ix=2,iy=3, icens=4,boolsave=FALSE)

# Different methods to handle LOQ
yvir50.omit<-autonpde(virload50,simvirload,iid=1,ix=2,iy=3, icens=4,boolsave=FALSE, cens.method="omit")

yvir50.ppred<-autonpde(virload50,simvirload,iid=1,ix=2,iy=3, icens=4,boolsave=FALSE, cens.method="ppred")

yvir50.ipred<-autonpde(virload50,simvirload,iid=1,ix=2,iy=3, icens=4, iipred=5, boolsave=FALSE, cens.method="ipred")

if(savePaperPlots) {
  paperFigs<-"/home/eco/xtex/npde/aaps20/figs"
  namfile<-file.path(paperFigs,"npdeDefault.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir1,bin.method="optimal")
  dev.off()  
}
```



```{r warfarinRun, include=FALSE,echo=FALSE,error=FALSE, warning=FALSE,message=FALSE}
data(warfarin)
data(simwarfarinBase)
data(simwarfarinCov)

wbase<-autonpde(namobs=warfarin,namsim=simwarfarinBase, iid=1,ix=2,iy=4,icov=c(3,6:8),namsav="warfBase", units=list(x="hr",y="ug/L", covariates=c("mg","kg","-","yr")))

wcov<-autonpde(namobs=warfarin,namsim=simwarfarinCov, iid=1,ix=2,iy=4,icov=c(3,6:8),namsav="warfCov", units=list(x="hr",y="ug/L", covariates=c("mg","kg","-","yr")))

# Warfarin with MDV
datDir<-file.path(workDir,"npde","data")
warfmdv<-read.table(file.path(datDir, "warfarin.tab"), header=TRUE)
idx<-sample(1:dim(warfmdv)[1], 10)
warfmdv$mdv<-0
warfmdv$mdv[idx]<-1
expect_equal(sum(warfmdv$mdv),10)

wmdv<-autonpde(namobs=warfmdv,namsim=file.path(datDir, "simwarfarinCov.tab"), iid=1,ix=2,iy=4,imdv=9,icov=c(3,6:8),namsav="warfBase", units=list(x="hr",y="ug/L", covariates=c("mg","kg","-","yr")))

```

## Test plots - default options
  
### Default plots for theophylline data

- **BUGS Romain TODOO**
  - title: in the waffle plot, only one title should appear, above all the 4 graphs (not one title per graph)
  - no axes in the histogram plot => add
  - **X-range on PI** extend prediction band to min/max X (it seems to stop at the center of the bin) => option ???
  - **global options** not passing on to the functions
    - size
      - normalement si l'utilisateur spécifie "size=2" sans spécifier size.pobs, size.pobs devrait passer à 1.5, et là ça ne semble rien changer
      - ni dans le graphe par défault (ie les 4 graphes), ni individuellement 
    - colours
      - when only col is specified, it should affect other elements (but not sure which we had decided), here only affects histogram and col.lobs for qqplot
      - col => col.pobs, col.lobs, col.pcens ?
      - col.lobs ne change rien, devrait changer les lignes correspondant aux percentiles et les lignes dans l'histograme
- **WARNING** attention aux effets de bord !!!
  - dans **set.plotoptions.NpdeObject**, xlab et ylab étaient fixés par défaut or on veut pouvoir les fixer automatiquement dans les fonctions graphiques tout en laissant l'utilisateur les passer en argument => on ne peut pas les mettre par défaut (xlab et ylab dépendent ici des variables qu'on veut tracer) => réfléchir avant de faire un truc comme ça (ou bien documenter qu'on puisse voir pourquoi ça plante, sinon on perd du temps à trouver pourqoui ça ne marche pas)

```{r theoPlots, echo=FALSE}
plot(theofit1)
plot(theofit1, main="Theophylline data")
plot(theofit1, which="pd")
plot(theofit1, which="npd")
plot(theofit1, which="faux") # should throw an error => yes

# ci-dessous le passage de size ne semble pas marhcer
cat("Failed tests, doesn't change as expected:\n")
#if(F) { # la taille de size.pobs (et size.pcens) n'est pas modifiée
  plot(theofit1,size=5)
  plot(theofit1,col="green")
#}

```

  

### Default plots for viral load data

- computation of the PI: seems appropriate in the different cases
- **Problems**  \textcolor{red}{(Eco)}
  - PI for omit aren't consistent with the VPC later on
    - **documentation** explain how PI are computed in the omit case

```{r virloadPlots, echo=FALSE}
plot(yvir1, main="Complete dataset") # complete data
plot(yvir50, main="Dataset censored 50 cp/mL") # imputing LOQ data using cdf (recommended)
plot(yvir50.omit, main="Censored 50, censoring=omit") # omitting LOQ data
plot(yvir50.ipred, main="Censored 50, censoring=ipred") # imputing to individual predictions
plot(yvir50.ppred, main="Censored 50, censoring=ppred") # imputing to population predictions

plot(yvir50, which="pd")

# Debug
if(FALSE) {
  npde.plot.scatterplot(yvir50.omit)
  npde.plot.dist(yvir50.omit)
  
  npdeObject<-yvir50.omit
  which<-"npde"
  plot.opt<-yvir50.omit@prefs
  
  which.x<-"x"
  which.y<-which
}

```

## Plots with default options

### Scatterplots

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - ylab for scatterplot doesn't appear (but works in waffle plot, wtf ?)
  - **size** ne passe pas (devrait changer à la fois size.pobs et size.pcens)
    - même pb que dans le graphe par défault (ie les 4 graphes)
  - calling plot with plot.type="x.scatter" and which="pd" (eg) triggers the message "Option which.y= x.scatter not recognised" => debug call to intermediate functions with arguments in **plotNpde-methods.R** (dispatching arguments given in ...)
  - plot.box has a weird aspect with seemingly empty boxes for the first 2 bins ?
- **Check**
  - size of boxes when plot.box=TRUE

```{r theoPlotsScatter, echo=FALSE}
plot(yvir20, plot.type="x.scatter") # no ylab ?
plot(yvir20, plot.type="pred.scatter")
# plot(yvir20) # ylab appears

plot(theofit1, plot.type="x.scatter", which="pd")
plot(theofit1, plot.type="pred.scatter", which="pd")

plot(yvir20, plot.type="x.scatter", plot.box=TRUE)

# ci-dessous le passage de size ne semble pas marcher
cat("Failed tests, size doesn't change size.pobs and size.pcens as expected:\n")
plot(theofit1, plot.type="x.scatter",size=5)
if(F) { # la taille de size.pobs (et size.pcens) n'est pas modifiée
  plot(yvir50, plot.type="x.scatter",size.pobs=5, size.pcens=3, pch.pcens=20) #tout seul size.pcens et size.pobs passent
}
```

### Distribution plots

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - pb with **size** (comme plus haut, size ne passe pas, size.pobs/size.pcens passent)
- **Problems**  \textcolor{red}{(à résoudre Eco)}
  - **axe title** for ecdf plot (should be: 'npde' on X-axis (/pd/npd) and 'Empirical distribution function' on Y-axis) [done, check it works]

```{r theoPlotsDist, echo=FALSE}
plot(theofit1, plot.type="hist",which="npde")
plot(theofit1, plot.type="qqplot",which="npde")
plot(theofit1, plot.type="ecdf",which="npde")

# Same plots for pd, OK
plot(theofit1, plot.type="hist", which="pd")
plot(theofit1, plot.type="qqplot", which="pd")
plot(theofit1, plot.type="ecdf", which="pd")

# la taille de size.pobs (et size.pcens) n'est pas modifiée
cat("Failed tests, size doesn't change size.pobs and size.pcens as expected:\n")
  plot(yvir20, plot.type="qqplot", which="npde",size=5)


if(F) { # si on passe size.pobs directement ça marche
  plot(yvir20, plot.type="qqplot", which="npde",size.pobs=5)
}

if(FALSE) { # ecdf of a uniform distribution (Eco check)
  x1<-runif(1000)
  plot(sort(x1),c(1:1000)/1000)
}
```

### Data plots

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - plot d'un **objet npdeData** ne marche pas
    - par contre plot.type="data" de l'objet npdeObject fonctionne => bizarre, vérifier [normalement plot.type="data" devrait appeler plot(objet@data) mais là ça semble court-circuiter ceci => à rectifier, on veut plutôt l'inverse]
  - problem with the data in the presence of **LOQ data**, the data being plotted is the LOQ
    - if applied directly to an objet npdeData (eg *plot(yivr50@data)*) => should plot y or the LOQ (ie censoring value)
    - if applied to the **npdeObject** resulting from a run => data plotted should depend on the censoring method (same as VPC)
      - for cdf, plot imputed y
      - for omit, don't plot anything
      - for ipred, plot ipred
      - for ppred, plot ppred
    - all other options should be the same [axis titles, axes, grid, default colours, etc...]
  - **lines for axes** don't appear
  - **size** 
    - size should be controlled by size.pobs and size.pcens, currently too small (not the same defaults as for the other plots ?)
    - size doesn't change size.pobs and size.lobs as it should
    - size.lobs doesn't work
  - **axis titles**
    - missing for theofit, why ? (present for yvir50, so odd)
  - **line.loq** doesn't work (no line appears at the LOQ)

```{r theoPlotsData, echo=FALSE}
#Plotting the theophylline data (R vanilla)
plot(Conc~Time,data=theopp,xlab="Time after dose (hr)",ylab="Theophylline concentration (mg/L)")

cat("Failed test, no output\n")
plot(theofit1@data) # ne marche pas
cat("Failed tests, not consistent with the other graphs, missing xlab, ylab, axes...\n")
plot(theofit1, plot.type="data") # marche mais manque les titres, les lignes sur les axes, la taille des points ne va pas
plot(yvir50, plot.type="data") # marche mais manque les lignes sur les axes, la taille des points ne va pas
plot(yvir50.omit, plot.type="data") # marche mais manque les lignes sur les axes, la taille des points ne va pas, et les données LOQ ne devraient pas être tracées

plot(yvir50, plot.type="data",plot.loq=FALSE)
plot(yvir50, plot.type="data",plot.loq=FALSE, line.loq=TRUE)

# ci-dessous le passage de size ne semble pas marhcer
if(F) { # la taille de size.pobs (et size.pcens) n'est pas modifiée
  plot(yvir50,plot.type="data",size=5) # should change size.pobs and size.pcens (? also size.lcol ?)
  plot(yvir50,plot.type="data",size.pobs=5, size.pcens=2) # ok
  plot(yvir50,plot.type="data",size.lobs=5) # doesn't change the size of the lines
}
```

### VPC

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - **Y-axis**  missing
  - problem with the PI not being interpolated properly (??? thought that worked :-/ )

- **Notes to check Eco**
  - computation of the PI for **omit** consistent with the PI computed for npde ?
    - compute the PI in this case by omitting the data>LOQ for the simulated data as well, to be consistent with the way the PI are computed for npde
    - check also that the PI are computed consistently for ppred
    - ipred ??? in this case can't be consistent (we have isim in the dataset but not ipred) so keep the simulations as is
  - **but** VPC with LOQ data done as here => \textcolor{red}{Eco TODO:} expliquer dans la doc les méthodes de censoring et la différence entre les graphes npde et VPC dans le cas de la méthode omit (message=the discrepancy seen in VPC comes from not treating observed and simulated data in the same way, "corrected" in npde but at the price of a loss of power)

```{r theoPlotsVPC, echo=FALSE}
plot(theofit1, plot.type="vpc")

plot(yvir50.omit, plot.type="vpc", main="Viral load, method=omit") # correct except Y-axis title
plot(yvir50, plot.type="vpc", main="Viral load, method=cdf") 
plot(yvir50.ipred, plot.type="vpc", main="Viral load, method=ipred")
plot(yvir50.ppred, plot.type="vpc", main="Viral load, method=ppred")

plot(yvir20, plot.type="vpc", plot.box=TRUE)

```

## P(Y<LOQ)

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - fails 
  - avant, vérifier:
    - **PI** on ne voit pas les bornes extérieures du PI (ça devrait être contrôlé par lty.bands et col.bands aussi)
    - **axes** missing lines for axes
    - **lwd.bands** should probably be increased for this plot :-/ (compared to the others), but never mind => show an example in Beautiful graphs

```{r virPlotsPloq, echo=FALSE}
try(plot(yvir20, plot.type="loq"))
try(plot(yvir20, plot.type="loq", lwd.bands=0.75)) # more visible, show this in second documentation
```

## Covariate plots

## Covariates

### Splitting plots according to covariates

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - yes here we really need to extend PI to cover the whole X-range for x.scatter and pred.scatter (not VPC)
    - just the PI (not the observed percentiles or outlier bands)
  - **covsplit**
    - doesn't work with the default plots => behaviour TBD
      - with one covariate, gives default plot (not split by the covariate)
      - with several covariates, message *arrangeGrob(...) ...: nrow * ncol >= n is not TRUE
      - we should get default plots for each category of the covariate but maybe only for one covariate ??? (too crowded otherwise)
- **Problems**  \textcolor{red}{(à résoudre Eco)}
  - ordering categorical variable (?)
  - why is there a blank space in the pred.scatter plot for sex=1 ?
- **other checks to do**
  - check if PI extend on the X-range when less homogenous data

```{r warfCov, echo=FALSE}
plot(wcov, plot.type="x.scatter") # ok but see above and owuld like to see x-range extended

# Working
plot(wcov, plot.type="x.scatter", covsplit=TRUE, which.cov=c("sex"))
plot(wcov, plot.type="x.scatter", covsplit=TRUE, which.cov=c("wt"))
plot(wcov, plot.type="x.scatter", covsplit=TRUE, which.cov=c("sex","wt"))
plot(wcov, plot.type="pred.scatter", covsplit=TRUE, which.cov=c("sex","wt"))
plot(wcov, plot.type="vpc", covsplit=TRUE, which.cov=c("sex","wt"))
plot(wcov, plot.type="x.scatter", covsplit=TRUE)

# Passing limits to the plot doesn't work
plot(wcov, plot.type="vpc", covsplit=TRUE, which.cov=c("sex","wt"),xlim=c(0,80))
plot(wcov, plot.type="vpc",ylim=c(0,30),covsplit=TRUE, which.cov=c("wt"))
plot(wcov, covsplit=TRUE, which.cov="sex")
```

### Parameters versus covariates

- **Problems**  \textcolor{red}{(à résoudre Romain)}
  - yes here we really need to extend PI to cover the whole X-range for x.scatter and pred.scatter (not VPC)
    - just the PI (not the observed percentiles or outlier bands)
  - cov.scatter (eg npde versus covariates)
    - boxplot for categorical covariates (overlayed on PI)
    - here two different behaviours ?

```{r warfParvsCov, echo=FALSE}

plot(wcov, plot.type="cov.scatter", covsplit=TRUE)

plot(wcov, plot.type="cov.scatter", which.cov="wt")
plot(wcov, plot.type="cov.scatter", which.cov="wt", covsplit=TRUE) # same plot, covsplit=TRUE ignored as should be

cat("Test failed, not the expected behaviour\n")
plot(wcov, plot.type="cov.scatter", which.cov="sex")
plot(wcov, plot.type="cov.scatter", which.cov="sex", covsplit=TRUE) # covsplit=TRUE should be ignored and we should just get a boxplot
```

## Creating the plots for the user guide

### Theophylline

- Default plots and VPC: **OK pour doc**
- **Problem** with plot of data (see above)  

```{r doc.theo, echo=FALSE}
if(saveDocPlots) {
# Raw data
  namfile<-file.path(docFigs,"xtheo_data_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(theofit1@data)
  dev.off()
# Diagnostics plots  
  namfile<-file.path(docFigs,"theophylline_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(theofit1)
  dev.off()
# VPC
  namfile<-file.path(docFigs,"theophylline_vpc_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(theofit1,plot.type="vpc")
  dev.off()
}
```

### Viral load data

- **TODO**
  - plot data
  - est-ce que les fonctions graphiques 'de base' pourraient renvoyer les graphes comme objet pour pouvoir ensuite en faire un *grid.arrange()* (on avait parlé de cette option pour pouvoir faire ensuite ses propres graphes comme avant) ?
    - 2 graphes de données (voire 3)
    - 2 graphes de VPC côte à côte (=> donner code correspondant dans la doc)
    - **note** si c'est l'option plot.default il faudrait en changer le nom (pas du tout explicite), en un truc comme return ou return.plot...
  - corriger le graphe de VPC

```{r doc.virload, echo=FALSE}
# p1<-npde.plot.data(yvir50, plot.default=TRUE) # non, c'est pas ça

if(saveDocPlots) {
# Raw data
  namfile<-file.path(docFigs,"doc_data50_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50@data, plot.loq=FALSE)
  plot(yvir50@data, impute.loq=FALSE)
  dev.off()
# Diagnostics plots, cdf method (default)
  namfile<-file.path(docFigs,"x50_cdf_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50)
  dev.off()
# Diagnostics plots, omit method
  namfile<-file.path(docFigs,"x50_omit_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50.omit)
  dev.off()
# Diagnostics plots, ipred method
  namfile<-file.path(docFigs,"x50_ipred_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50.ipred)
  dev.off()
# Diagnostics plots, ppred method
  namfile<-file.path(docFigs,"x50_ppred_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50.ppred)
  dev.off()
# VPC
  namfile<-file.path(docFigs,"doc_vpc50_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50,plot.type="vpc")
  plot(yvir50.omit,plot.type="vpc")
  dev.off()
# P(Y<LOQ)
  namfile<-file.path(docFigs,"virload_ploq_gg.eps")
  cairo_ps(file = namfile, onefile = TRUE, fallback_resolution = 600, height=8.27, width=11.69)
  plot(yvir50,plot.type="loq", main=" ")
  dev.off()
}
```

## End of file, deactivating development mode

```{r deactivateDevMode, echo=FALSE, hide=T}
dev_mode()
```

